<!DOCTYPE html>
<html>
<head>
<!--script src="music.js"></script-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="Music.js"></script>
<script src="MusicGame.js"></script>
<script src="SongPlayer.js"></script>
<script>
//Globally-scoped stuff
var game = new MusicGame();
var context = new AudioContext();

const notes = ['A4', 'B4', 'C4'];
//D–A–Bm–G
const chords = {
	A: {
		major: ['A', 'Db', 'E'],
		minor: ['A', 'C', 'E']
	},
	Bb: {
		major: ['Bb', 'D', 'F'],
		minor: ['Bb', 'Db', 'F']
	},
	B: {
		major : ['B', 'Eb', 'Gb'],
		minor: ['B', 'D', 'Gb']
	},
	//This is just B but here for completeness
	Cb: {
		major: ['B', 'Eb', 'Gb'],
		minor: ['B', 'D', 'Gb']
	},
	// Starts here...
	C: {
		major: ['C', 'E', 'G'],
		minor: ['C', 'Eb', 'G']
	},
	Db: {
		major: ['Db', 'F', 'Ab'],
		minor: ['Db', 'E', 'Ab']
	},
	D: {
		major: ['D', 'Gb', 'A'],
		minor: ['D', 'F', 'A']
	},
	Eb: {
		major: ['Eb', 'G', 'Bb'],
		minor: ['Eb', 'Gb', 'Bb']
	},
	E: {
		major: ['E', 'Ab', 'B'],
		minor: ['E', 'G', 'B']
	},
	//This is just E but here for completeness?
	Fb: {
		major: ['E', 'Ab', 'B'],
		minor: ['E', 'G', 'B']
	},
	F: {
		major: ['F', 'A', 'C'],
		minor: ['F', 'Ab', 'C']
	},
	Gb: {
		major: ['Gb', 'Bb', 'Db'],
		minor: ['Gb', 'A', 'Db']
	},
	G: {
		major: ['G', 'B', 'D'],
		minor: ['G', 'Bb', 'D']
	},
	Ab: {
		major: ['Ab', 'C', 'Eb'],
		minor: ['Ab', 'Cb', 'F']
	}
}

let fourChords = [
	chords['D']['major'],
	chords['A']['major'],
	chords['B']['minor'],
	chords['G']['major'],
	//
	chords['E']['major'],
	chords['A']['minor'],
	chords['D']['major'],
	chords['G']['major']
	//chords['Db']['major']
];

const Dbmin = chords['Db']['minor'];
const Dmaj = chords['D']['major'];
const Amaj = chords['A']['major'];
const Bmin = chords['B']['minor'];
const Gmaj = chords['G']['major'];
const fourCh = [
	Dmaj,
	Amaj,
	Bmin,
	Gmaj
];

//see https://en.m.wikipedia.org/wiki/SCORE_(software)
/*
 Db5W - A Db on octave 5 played as a Whole note
 C3H - A C on octave 3 played as a Half note (minim)
 B2Q - A B octave 2 Quarter note (crochet)
 Fb3E - An Fb octave 3 Eight note (quaver)
 B3S - A B octave 3 Sixteenth note (semiquaver)
 RE - A Rest played as an Eighth note
 
 B3E/C3E/D3E/F3E
 
 //Duration - extract the last char
 let duration = note.slice(-1);
 //Octave - second to last char
 let octave = note.slice(-2, 1);
 //key - first 1/2 chars, find the octave and count up to it
 let key = note.substr(0, note.indexOf(octave) - 1);
*/

const playRandomSong = () => {
	const song = {
		//CHANNEL 1
		bass: {
			settings: {
				wave: 'square',
				gain: 3
				//....
			},
			notes: [
				"B3W",
				"C3W",
				"E3H",
				"F3H",
				"G3W"
			]
		},
		//CHANNEL 2
		melody: {
			settings: {
				wave: 'saw',
				gain: 6
				//...
			},
			notes: [
				"E4W",
				"F4H",
				"G4H",
				"A4W",
				"B4H",
				"C4H",
				"E4Q",
				"G4Q",
				"F4Q",
				"E4Q"
			]
		},
		//...CHANNEL N
		settings: {
			bpm: 30
			//...
		}
	}
}


const ringtoneExamples = [
'JingleBell:d=8,o=5,b=112:32p,a,a,4a,a,a,4a,a,c6,f.,16g,2a,a#,a#,a#.,16a#,a#,a,a.,16a,a,g,g,a,4g,4c6',
'Halloween:d=4,o=5,b=180:8d6,8g,8g,8d6,8g,8g,8d6,8g,8d#6,8g,8d6,8g,8g,8d6,8g,8g,8d6,8g,8d#6,8g,8c#6,8f#,8f#,8c#6,8f#,8f#,8c#6,8f#,8d6,8f#,8c#6,8f#,8f#,8c#6,8f#,8f#,8c#6,8f#,8d6,8f#',
'Auld L S:d=4,o=6,b=101:g5,c,8c,c,e,d,8c,d,8e,8d,c,8c,e,g,2a,a,g,8e,e,c,d,8c,d,8e,8d,c,8a5,a5,g5,2c'
]

let chordPlayer = new Music();

//chordPlayer.playChord(chords['d']['major']);
//chordPlayer.playSong(fourChords, 500);
chordPlayer.playSong(fourCh, 500);


const outputScaleOptions = () => {
    let scaleEl = document.getElementById('scale');
    scaleEl.innerHTML = '';
    let music = new Music();
    Object.keys(music.scales).forEach( (k) => {
        let opt = document.createElement('option');
        opt.value = k;
        opt.innerHTML = k;
        scaleEl.appendChild(opt);
    })
}

outputRingtoneOptions = () => {
	let songNames = ringtoneExamples.map( (str) => {
		return str.split(':')[0];
	});
	let exampleEl = document.getElementById('examples');
	songNames.forEach( (k) => {
		let opt = document.createElement('option');
		opt.value = k;
		opt.innerHTML = k;
		exampleEl.appendChild(opt);
	})
}

updateRTTTL = (opt) => {
	let name = opt.value;
	let song = ringtoneExamples.find( (el) => {
		let sName = el.split(':')[0];
		return sName == name;
	});
	document.getElementById('rtttl').innerHTML = song;
}

playRTTTL = () => {
	let song = document.getElementById('rtttl').innerHTML;
	let p = new SongPlayer();
	p.playRTTTLSong(song);
}

//LITTLE HELPER FUNCTION TO CALL THE MUSIC CLASS
playMusicalScale = () => {
    //GET THE SELECTED KEY AND SCALE NAME
    let key = document.getElementsByName('key')[0].value;
    let scale = document.getElementsByName('scale')[0].value;
    let duration = document.getElementsByName('duration')[0].value;
    let basePitch = document.getElementsByName('basePitch')[0].value;
    //GET AN INSTANCE OF THE MUSIC CLASS
    let music = new Music();
    //SET THE BASE PITCH
    music.setBasePitch(basePitch);
    //PLAY THE SELECTED SCALE (AudioContext)
    music.playScale(key, scale, duration);
    //GET THE NOTES OF THIS SCALE TO OUTPUT TO THE SCREEN
    let scaleNotes = music.getScaleNotes(key,scale);
    //OUTPUT NOTES TO SCALE NOTES DIV
    document.getElementById('scaleNotesDiv').innerHTML = 'NOTES: ' + scaleNotes.join(" ");
}

const init = () => {
    outputScaleOptions();
    outputRingtoneOptions();
    showTab('gameSetup');
}

const playGame = () => {
    console.log('game started!');
    //let game = new MusicGame();
    const gameType = document.getElementById('gameType').value;
    game.setType(gameType);
    const difficulty = document.getElementById('difficulty').value;
    game.setDifficulty(difficulty);
    game.start();
    showTab('game');
}

const showTab = (tabName) => {
    const tabs = document.getElementsByClassName('tab');
    for(let i = 0; i < tabs.length; i++){
        tabs[i].style.display = 'none';
    }
    document.getElementById(tabName).style.display = 'block';
}
</script>

<style>
    * {
        background: #333;
        color: #fff;
        font-size: 1.2em;
    }
    body {
        margin: 1% 5%;
    }
    input, select {
        background: #ddd;
        color: #000;
        width: 90%;
        height: 2em;
        margin: 0 5%;
    }
    textarea {
    	height: 9em;
    	font-size: 0.9em;
    	background: #ddd;
        color: #000;
        width: 90%;
        margin: 0 5%;
    }
    button {
        font-size: 0.7em;
        padding: 2%;
        background: green;
        color: white;
        width: 90%;
        margin: 10px 5%;
    }
    button.nav {
        font-size: 0.8em;
        padding: 1%;
        width: auto;
        position: relative;
        margin: 0 5px;
        text-align: center;
    }
    h1 { 
        margin: 2px 5%;
        font-size: 1.5em;
    }
    h4, h5, p {
        padding: 5%;
        margin: 0;
    }
    h2 {
    	font-size: 1.3em;
    }
    h3 {
    	font-size: 1.2rem;
    }
    h4 {
    	font-size: 0.7em;
    }
    h5 {
    	font-size: 1.0em;
    }
    p, span {
    	font-size: 0.8em
    }
    #navbar {
        background-color: #000;
    }
    #hud #lives {
    	position: relative;
    	float: right;
    }
    button.answer:hover, button.answer:visited {
    	background-color: red;
    }
</style>

</head>
<body onload="init()">
    
    <h1>Music Playground</h1>
    
    <menu id="navbar">
        <button class="nav" onclick="showTab('scales')">Playground</button>
        <button class="nav" onclick="showTab('gameSetup')">Game</button>
        <button class="nav" onclick="showTab('ringtones')">Ringtone</button>
    </menu>
    
    <section id="scales" style="display: block;" class="tab">
        Key: 
        <select name="key">
                <option value="C">C</option>
                <option value="Db">Db</option>
                <option value="D">D</option>
                <option value="Eb">Eb</option>
                <option value="E">E</option>
                <option value="F">F</option>
                <option value="Gb">Gb</option>
                <option value="G">G</option>
                <option value="Ab">Ab</option>
                <option value="A">A</option>
                <option value="Bb">Bb</option>
                <option value="B">B</option>
        </select>

        <br><br>

        Scale: 
        <select id="scale" name="scale">
                <!-- filled by outputScaleOptions -->
        </select>

        <br><br>

        Duration (ms): 
        <input name="duration" type="number" value="200"/>

        <br><br>

        Base Pitch - Concert Pitch A4 = 440 (Hz): 
        <input name="basePitch" type="number" value="440"/>

        <br><br>

        <button id="playScale" onclick="playMusicalScale()">Play Scale</button>

        <br><br>

        <div id="scaleNotesDiv">
        </div>
        
        <button onclick="playRandomSong()">Random Song</button>
        
    </section>
    
    <section id="gameSetup" style="display: block;" class="tab">
        
        <h2>Game Setup</h2>
        
        Game Type: 
        <select id="gameType" name="gameType">
            <option value="key">Key Guess </option>
            <option value="scale" selected>Scale Guess</option>
            <option value="pitch">Pitch Guess</option>
        </select>
        
        Difficulty: 
        <select id="difficulty" name="difficulty ">
            <option value="easy">Easy</option>
            <option value="medium" selected>Medium</option>
            <option value="hard">Hard</option>
        </select>
        
        <br><br>
        
        <button onclick="playGame()">Play Game</button>
        
    </section>
    
    <section id="game" style="display: none;" class="tab">
        <!--h2>Game</h2-->
        <div id="gameOutput">
            
        </div>
    </section>
    
    <section id="ringtones" style="display: none;" class="tab">
        <h2>RTTTL (Ringtones)</h2>
        
        Examples: 
        <select id="examples" onchange="updateRTTTL(this)">
        	
        </select>
        
        <textarea id="rtttl">Paste an RTTTL string here!</textarea>
        
        <button id="playRTTTL" onclick="playRTTTL()">Play Ringtone</button>
    </section>
</body>
</html>