<!DOCTYPE html>
<html>
<head>
<!--script src="music.js"></script-->

<script>
class Music {
	//THE NAMES OF THE NOTES
	notes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

	/**
	 * Calculate the frequency for a note/octave string.
	 * @param {string} noteOctave The note and octave pair in the form A1 -> G8.
	 * @return float The calculated frequency of this note.
	 */
	calcFrequency = (noteOctave) => {
		//GET THE OCTAVE (THE LAST CHAR)
		const octave = noteOctave.slice(-1);
		//GET THE NOTE NAME (THE REST OF THE INPUT STRING)
		const note = noteOctave.replace(octave,'');
		//CALCULATE HOW MANY SEMITONES DIFFERENT FROM "A"
		const noteIndexDiff = this.notes.indexOf(note) - this.notes.indexOf('A');
		//WORK OUT HOW MANY SEMITONES ABOVE A4
		const semitones = ((octave - 4) * 12) + noteIndexDiff;
		//THIS IS THE BASE FREQUENCY (A4)
		const f0 = 440;
		//USE THE Math.pow() FUNCTION TO GET EXPONENT
		return (f0 * Math.pow(2, (semitones / 12)));
	}

	playNote = (key, duration) => {
		//CALCULATE THE REQUIRED FREQUENCY
		let frequency = this.calcFrequency(key);
		var context = new AudioContext();
		var oscillator = context.createOscillator();
		oscillator.type = "sine";
		oscillator.frequency.value = frequency;
		oscillator.connect(context.destination);
		oscillator.start();
		// Beep for 500 milliseconds
		setTimeout(function () {
			oscillator.stop();
		}, duration);
	}

	getScaleNotes(key, scaleName) {
		const scales = {
			major: [0, 2, 4, 5, 7, 9, 11],
			minor: [0, 2, 3, 5, 7, 8, 10],
			chromatic: [0,1,2,3,4,5,6,7,8,9,10,11],
			istrian: [0,1,3,4,6,7],
			locrian: [0,1,3,5,6,8,10],
			phrygian: [0,1,3,5,7,8,10],
			harmonicMinor: [0,2,3,5,7,8,11]
			// ... other scales
		};
		const scalePattern = scales[scaleName];
		//USING FLATS (b)
		const keyIndex = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'].indexOf(key);
		const notes = [];
		for (let i = 0; i < scalePattern.length; i++) {
			const noteIndex = (keyIndex + scalePattern[i]) % 12;
			//USING FLATS b
			notes.push(['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'][noteIndex]);
		}

		return notes;
	}

	playScale = () => {
		//CONSTANTS 
		const startOctave = 4;
		const duration = 500;
		//GET THE SELECTED KEY AND SCALE NAME
		let key = document.getElementsByName('key')[0].value;
		let scale = document.getElementsByName('scale')[0].value;
		//USE getScaleNotes TO GET THE TRANSPOSED NOTES FOR THIS SCALE
		let scaleNotes = this.getScaleNotes(key,scale);
		//GET THE ARRAY INDEX OF THE ROOT NOTE
		let startNoteIndex = this.notes.indexOf(key);
		//MAP TO AN OCTAVE (RETURNS E4, F4, G4 etc)
		scaleNotes = scaleNotes.map( (note) => { 
			//GET THE ARRAY INDEX OF THE CURRENT NOTE
			let currentNoteIndex = this.notes.indexOf(note);
			//IS THIS BELOW THE START NOTE (i.e. WE HAVE GONE UP AN OCTAVE)
			if(currentNoteIndex < startNoteIndex){
				//MOVE UP AN OCTAVE
				return note + "" + (startOctave + 1);
			}else{
				//USE CURRENT OCTAVE
				return (note + startOctave); 
			}
		});
		//THEN ADD THE ROOT BACK ON AN OCTAVE HIGHER
		scaleNotes.push(key + (startOctave + 1));
		//FOR EACH NOTE (Eb4, F4, A5 etc)
		scaleNotes.forEach( (note, index) => {
			//SET A TIMEOUT BASED ON THE INDEX (i.e. WAIT LONGER FOR LATER NOTES)
			setTimeout(this.playNote, index * duration, note, duration);
		});
	}
}

//LITTLE HELPER FUNCTION TO CALL THE MUSIC CLASS
playMusicalScale = () => {
	let music = new Music();
	music.playScale();
}

</script>

</head>
<body>
	Key: <select name="key">
		<option value="C">C</option>
		<option value="Db">Db</option>
		<option value="D">D</option>
		<option value="Eb">Eb</option>
		<option value="E">E</option>
		<option value="F">F</option>
		<option value="Gb">Gb</option>
		<option value="G">G</option>
		<option value="Ab">Ab</option>
		<option value="A">A</option>
		<option value="Bb">Bb</option>
		<option value="B">B</option>
	</select>
	Scale: <select name="scale">
		<option value="major">major</option>
		<option value="minor">minor</option>
		<option value="chromatic">chromatic</option>
		<option value="istrian">istrian</option>
		<option value="locrian">locrian</option>
		<option value="phrygian">phrygian</option>
		<option value="harmonicMinor">harmonicMinor</option>
	</select>
	<button id="playScale" onclick="playMusicalScale()">Play Scale</button>
</body>
</html>